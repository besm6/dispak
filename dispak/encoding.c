/*
 * Encoding tables.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.
 *
 * You can redistribute this program and/or modify it under the terms of
 * the GNU General Public License as published by the Free Software Foundation;
 * either version 2 of the License, or (at your discretion) any later version.
 * See the accompanying file "COPYING" for more details.
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "encoding.h"
#include "gost10859.h"
#include "gettext.h"

int gost_latin = 0; /* default cyrillics */

static int (*local_getc) (FILE *fin);
static void (*local_putc) (unsigned short ch, FILE *fout);

/*
 * GOST-10859 encoding.
 * Documentation: http://en.wikipedia.org/wiki/GOST_10859
 */
static const unsigned short gost_to_unicode_cyr [256] = {
/* 000-007 */	0x30,   0x31,   0x32,   0x33,   0x34,   0x35,   0x36,   0x37,
/* 010-017 */	0x38,   0x39,   0x2b,   0x2d,   0x2f,   0x2c,   0x2e,   0x20,
/* 020-027 */	0x65,   0x2191, 0x28,   0x29,   0xd7,   0x3d,   0x3b,   0x5b,
/* 030-037 */	0x5d,   0x2a,   0x2018, 0x2019, 0x2260, 0x3c,   0x3e,   0x3a,
/* 040-047 */	0x0410, 0x0411, 0x0412, 0x0413, 0x0414, 0x0415, 0x0416, 0x0417,
/* 050-057 */	0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e, 0x041f,
/* 060-067 */	0x0420, 0x0421, 0x0422, 0x0423, 0x0424, 0x0425, 0x0426, 0x0427,
/* 070-077 */	0x0428, 0x0429, 0x042b, 0x042c, 0x042d, 0x042e, 0x042f, 0x44,
/* 100-107 */	0x46,   0x47,   0x49,   0x4a,   0x4c,   0x4e,   0x51,   0x52,
/* 110-117 */	0x53,   0x55,   0x56,   0x57,   0x5a,   0x203e, 0x2264, 0x2265,
/* 120-127 */	0x2228, 0x2227, 0x2283, 0xac,   0xf7,   0x2261, 0x25,   0x25c7,
/* 130-137 */	0x7c,   0x2015, 0x5f,   0x21,   0x22,   0x042a, 0xb0,   0x2032,
};

static const unsigned short gost_to_unicode_lat [256] = {
/* 000-007 */   0x30,   0x31,   0x32,   0x33,   0x34,   0x35,   0x36,   0x37,
/* 010-017 */   0x38,   0x39,   0x2b,   0x2d,   0x2f,   0x2c,   0x2e,   0x20,
/* 020-027 */   0x65,   0x2191, 0x28,   0x29,   0xd7,   0x3d,   0x3b,   0x5b,
/* 030-037 */   0x5d,   0x2a,   0x2018, 0x2019, 0x2260, 0x3c,   0x3e,   0x3a,
/* 040-047 */   0x41,   0x0411, 0x42,   0x0413, 0x0414, 0x45,   0x0416, 0x0417,
/* 050-057 */   0x0418, 0x0419, 0x4b,   0x041b, 0x4d,   0x48,   0x4f,   0x041f,
/* 060-067 */   0x50,   0x43,   0x54,   0x59,   0x0424, 0x58,   0x0426, 0x0427,
/* 070-077 */   0x0428, 0x0429, 0x042b, 0x042c, 0x042d, 0x042e, 0x042f, 0x44,
/* 100-107 */   0x46,   0x47,   0x49,   0x4a,   0x4c,   0x4e,   0x51,   0x52,
/* 110-117 */   0x53,   0x55,   0x56,   0x57,   0x5a,   0x203e, 0x2264, 0x2265,
/* 120-127 */   0x2228, 0x2227, 0x2283, 0xac,   0xf7,   0x2261, 0x25,   0x25c7,
/* 130-137 */   0x7c,   0x2015, 0x5f,   0x21,   0x22,   0x042a, 0xb0,   0x2032,
};

unsigned char
unicode_to_gost (unsigned short val)
{
	static const unsigned char tab0 [256] = {
/* 00 - 07 */	017,	017,	017,	017,	017,	017,	017,	017,
/* 08 - 0f */	017,	017,	0214,	017,	017,	0174,	017,	017,
/* 10 - 17 */	017,	017,	017,	017,	017,	017,	017,	017,
/* 18 - 1f */	017,	017,	017,	017,	017,	017,	017,	017,
/*  !"#$%&' */	0017,	0133,	0134,	0034,	0127,	0126,	0121,	0033,
/* ()*+,-./ */	0022,	0023,	0031,	0012,	0015,	0013,	0016,	0014,
/* 01234567 */	0000,	0001,	0002,	0003,	0004,	0005,	0006,	0007,
/* 89:;<=>? */	0010,	0011,	0037,	0026,	0035,	0025,	0036,	0136,
/* @ABCDEFG */	0021,	0040,	0042,	0061,	0077,	0045,	0100,	0101,
/* HIJKLMNO */	0055,	0102,	0103,	0052,	0104,	0054,	0105,	0056,
/* PQRSTUVW */	0060,	0106,	0107,	0110,	0062,	0111,	0112,	0113,
/* XYZ[\]^_ */	0065,	0063,	0114,	0027,	017,	0030,	0115,	0132,
/* `abcdefg */	0032,	0040,	0042,	0061,	0077,	0045,	0100,	0101,
/* hijklmno */	0055,	0102,	0103,	0052,	0104,	0054,	0105,	0056,
/* pqrstuvw */	0060,	0106,	0107,	0110,	0062,	0111,	0112,	0113,
/* xyz{|}~  */	0065,	0063,	0114,	017,	0130,	017,	0123,	017,
/* 80 - 87 */	017,	017,	017,	017,	017,	017,	017,	017,
/* 88 - 8f */	017,	017,	017,	017,	017,	017,	017,	017,
/* 90 - 97 */	017,	017,	017,	017,	017,	017,	017,	017,
/* 98 - 9f */	017,	017,	017,	017,	017,	017,	017,	017,
/* a0 - a7 */	017,	017,	017,	017,	017,	017,	017,	017,
/* a8 - af */	017,	017,	017,	017,	0123,	017,	017,	017,
/* b0 - b7 */	0136,	017,	017,	017,	017,	017,	017,	017,
/* b8 - bf */	017,	017,	017,	017,	017,	017,	017,	017,
/* c0 - c7 */	017,	017,	017,	017,	017,	017,	017,	017,
/* c8 - cf */	017,	017,	017,	017,	017,	017,	017,	017,
/* d0 - d7 */	017,	017,	017,	017,	017,	017,	017,	0024,
/* d8 - df */	017,	017,	017,	017,	017,	017,	017,	017,
/* e0 - e7 */	017,	017,	017,	017,	017,	017,	017,	017,
/* e8 - ef */	017,	017,	017,	017,	017,	017,	017,	017,
/* f0 - f7 */	017,	017,	017,	017,	017,	017,	017,	0124,
/* f8 - ff */ 	017,	017,	017,	017,	017,	017,	017,	017,
	};
	switch (val >> 8) {
	case 0x00:
		return tab0 [val];
	case 0x04:
		switch ((unsigned char) val) {
		case 0x10: return 0040;
		case 0x11: return 0041;
		case 0x12: return 0042;
		case 0x13: return 0043;
		case 0x14: return 0044;
		case 0x15: return 0045;
		case 0x16: return 0046;
		case 0x17: return 0047;
		case 0x18: return 0050;
		case 0x19: return 0051;
		case 0x1a: return 0052;
		case 0x1b: return 0053;
		case 0x1c: return 0054;
		case 0x1d: return 0055;
		case 0x1e: return 0056;
		case 0x1f: return 0057;
		case 0x20: return 0060;
		case 0x21: return 0061;
		case 0x22: return 0062;
		case 0x23: return 0063;
		case 0x24: return 0064;
		case 0x25: return 0065;
		case 0x26: return 0066;
		case 0x27: return 0067;
		case 0x28: return 0070;
		case 0x29: return 0071;
		case 0x2a: return 0135;
		case 0x2b: return 0072;
		case 0x2c: return 0073;
		case 0x2d: return 0074;
		case 0x2e: return 0075;
		case 0x2f: return 0076;
		case 0x30: return 0040;
		case 0x31: return 0041;
		case 0x32: return 0042;
		case 0x33: return 0043;
		case 0x34: return 0044;
		case 0x35: return 0045;
		case 0x36: return 0046;
		case 0x37: return 0047;
		case 0x38: return 0050;
		case 0x39: return 0051;
		case 0x3a: return 0052;
		case 0x3b: return 0053;
		case 0x3c: return 0054;
		case 0x3d: return 0055;
		case 0x3e: return 0056;
		case 0x3f: return 0057;
		case 0x40: return 0060;
		case 0x41: return 0061;
		case 0x42: return 0062;
		case 0x43: return 0063;
		case 0x44: return 0064;
		case 0x45: return 0065;
		case 0x46: return 0066;
		case 0x47: return 0067;
		case 0x48: return 0070;
		case 0x49: return 0071;
		case 0x4a: return 0135;
		case 0x4b: return 0072;
		case 0x4c: return 0073;
		case 0x4d: return 0074;
		case 0x4e: return 0075;
		case 0x4f: return 0076;
		}
		break;
	case 0x20:
		switch ((unsigned char) val) {
		case 0x15: return 0131;
		case 0x18: return 0032;
		case 0x19: return 0033;
		case 0x32: return 0137;
		case 0x3e: return 0115;
		}
		break;
	case 0x21:
		switch ((unsigned char) val) {
		case 0x2f: return 0020;
		case 0x91: return 0021;
		}
		break;
	case 0x22:
		switch ((unsigned char) val) {
		case 0x27: return 0121;
		case 0x28: return 0120;
		case 0x60: return 0034;
		case 0x61: return 0125;
		case 0x64: return 0116;
		case 0x65: return 0117;
		case 0x83: return 0122;
		}
		break;
	case 0x23:
		switch ((unsigned char) val) {
		case 0xe8: return 0020;
		}
		break;
	case 0x25:
		switch ((unsigned char) val) {
		case 0xc7: return 0127;
		case 0xca: return 0127;
		}
		break;
	}
	return 017;
}

/*
 * Encoding of ITM autocode.
 * Documentation: http://besm6.googlegroups.com/web/%D0%90%D0%B2%D1%82%D0%BE%D0%BA%D0%BE%D0%B4-%D0%91%D0%AD%D0%A1%D0%9C6-%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%86%D0%B8%D1%8F.pdf
 */
const unsigned char itm_to_gost [256] =
{
/* 000 */	GOST_0,			GOST_1,
		GOST_2,			GOST_3,
		GOST_4,			GOST_5,
		GOST_6,			GOST_7,
/* 010 */	GOST_8,			GOST_9,
		0,			0,
		0,			0,
		0,			GOST_SPACE,
/* 020 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 030 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 040 */	GOST_SPACE,		GOST_RIGHT_QUOTATION,
		GOST_DIAMOND,		GOST_UNDERLINE,
		GOST_VERTICAL_LINE,	GOST_SEMICOLON,
		GOST_COMMA,		GOST_DOT,
/* 050 */	GOST_OVERLINE,		GOST_RIGHT_PARENTHESIS,
		0,			GOST_LEFT_BRACKET,
		GOST_GREATER_THAN,	GOST_DEGREE,
		GOST_COLON,		GOST_EQUALS,
/* 060 */	GOST_V,			GOST_PLUS,
		GOST_PERCENT,		GOST_EXCLAMATION,
		GOST_LEFT_QUOTATION,	GOST_COLON,
		GOST_RIGHT_BRACKET,	GOST_SLASH,
/* 070 */	GOST_MINUS,		GOST_LOGICAL_AND,
		GOST_X,			0,
		GOST_LESS_THAN,		GOST_LEFT_QUOTATION,
		GOST_LEFT_PARENTHESIS,	0,
/* 100 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 110 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 120 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 130 */	0,			0,
		0,			0,
		GOST_QUOTATION,		GOST_HARD_SIGN,
		0,			GOST_RIGHT_QUOTATION,
/* 140 */	0,			0,
		0,			GOST_UPWARDS_ARROW,
		0,			GOST_NOT,
		GOST_LESS_THAN,		GOST_GREATER_THAN,
/* 150 */	GOST_MINUS,		0,
		GOST_NOT_EQUAL_TO,	0,
		0,			0,
		0,			0,
/* 160 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 170 */	GOST_ASTERISK,		0,
		0,			0,
		0,			0,
		GOST_E,			0,
/* 200 */	0,			GOST_T,
		0,			GOST_O,
		0,			GOST_H,
		GOST_N,			GOST_M,
/* 210 */	0,			GOST_L,
		GOST_R,			GOST_G,
		GOST_I,			GOST_P,
		GOST_C,			GOST_V,
/* 220 */	GOST_E,			GOST_Z,
		GOST_D,			GOST_B,
		GOST_S,			GOST_Y,
		GOST_F,			GOST_X,
/* 230 */	GOST_A,			GOST_W,
		GOST_J,			0,
		GOST_U,			GOST_Q,
		GOST_K,			0,
/* 240 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 250 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 260 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 270 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 300 */	0,			GOST_SHCHA,
		0,			0,
		0,			0,
		0,			0,
/* 310 */	0,			GOST_EL,
		0,			GOST_GHE,
		GOST_CYRILLIC_I,	GOST_PE,
		GOST_TSE,		GOST_ZHE,
/* 320 */	GOST_REVERSE_E,		GOST_ZE,
		GOST_DE,		GOST_BE,
		GOST_SHA,		GOST_YERU,
		GOST_EF,		GOST_SOFT_SIGN,
/* 330 */	0,			GOST_CHE,
		GOST_SHORT_I,		0,
		GOST_YU,		GOST_YA,
		0,			0,
/* 340 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 350 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 360 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
/* 370 */	0,			0,
		0,			0,
		0,			0,
		0,			0,
};

const unsigned char gost_to_itm [256] =
{
/* 000-007 */	0000,	0001,	0002,	0003,	0004,	0005,	0006,	0007,
/* 010-017 */	0010,	0011,	0061,	0070,	0067,	0046,	0047,	0017,
/* 020-027 */	0220,	0143,	0076,	0051,	0227,	0057,	0045,	0053,
/* 030-037 */	0066,	0170,	0064,	0041,	0152,	0074,	0054,	0056,
/* 040-047 */	0230,	0323,	0223,	0313,	0322,	0220,	0317,	0321,
/* 050-057 */	0314,	0332,	0236,	0311,	0207,	0205,	0203,	0315,
/* 060-067 */	0215,	0216,	0201,	0225,	0326,	0227,	0316,	0331,
/* 070-077 */	0324,	0301,	0325,	0327,	0320,	0334,	0335,	0222,
/* 100-107 */	0226,	0213,	0214,	0232,	0211,	0206,	0235,	0212,
/* 110-117 */	0224,	0234,	0217,	0231,	0221,	0050,	0000,	0000,
/* 120-127 */	0217,	0071,	0055,	0145,	0000,	0057,	0062,	0042,
/* 130-137 */	0044,	0070,	0043,	0063,	0134,	0136,	0064,	0041,
};

/*
 * "Text" encoding of monitoring system Dubna.
 */
const unsigned char text_to_gost [64] =
{
/* 000 */	GOST_SPACE,		GOST_DOT,
		GOST_BE,		GOST_TSE,
		GOST_DE,		GOST_EF,
		GOST_GHE,		GOST_CYRILLIC_I,
/* 010 */	GOST_LEFT_PARENTHESIS,	GOST_RIGHT_PARENTHESIS,
		GOST_ASTERISK,		GOST_SHORT_I,
		GOST_EL,		GOST_YA,
		GOST_ZHE,		GOST_SLASH,
/* 020 */	GOST_0,			GOST_1,
		GOST_2,			GOST_3,
		GOST_4,			GOST_5,
		GOST_6,			GOST_7,
/* 030 */	GOST_8,			GOST_9,
		GOST_SOFT_SIGN,		GOST_COMMA,
		GOST_PE,		GOST_MINUS,
		GOST_PLUS,		GOST_YERU,
/* 040 */	GOST_ZE,		GOST_A,
		GOST_B,			GOST_C,
		GOST_D,			GOST_E,
		GOST_F,			GOST_G,
/* 050 */	GOST_H,			GOST_I,
		GOST_J,			GOST_K,
		GOST_L,			GOST_M,
		GOST_N,			GOST_O,
/* 060 */	GOST_P,			GOST_Q,
		GOST_R,			GOST_S,
		GOST_T,			GOST_U,
		GOST_V,			GOST_W,
/* 070 */	GOST_X,			GOST_Y,
		GOST_Z,			GOST_SHA,
		GOST_REVERSE_E,		GOST_SHCHA,
		GOST_CHE,		GOST_YU,
};

/* Although Linux seems to support ungetc up to 1000 chars, let's not rely on it */
static char ungetbuf[1000];            /* enough for one punchcard */
static int ungetptr;
static int
utf8_getc_raw (FILE *fin)
{
    int c1, c2, c3;
    /* We only ungetc ASCII chars '.' and 'O'. */
    c1 = ungetptr ? ungetbuf[--ungetptr] : getc (fin);
    if (c1 < 0 || ! (c1 & 0x80))
        return c1;
    c2 = getc (fin);
    if (! (c1 & 0x20))
        return (c1 & 0x1f) << 6 | (c2 & 0x3f);
    c3 = getc (fin);
    return (c1 & 0x0f) << 12 | (c2 & 0x3f) << 6 | (c3 & 0x3f);

}
/* A card image is pushed back in the form of dots and Os only if well-formed.
 * Stray Braille patterns are ignored.
 */
static void
read_braille(int cur, FILE *fin)
{
    static char bits[12][80];
    int count = 0, line, col;
    do {
        line = count / 40 * 4;
        col = count % 40 * 2;
        bits[line][col] = cur & 0x01;
        bits[line+1][col] = cur & 0x02;
        bits[line+2][col] = cur & 0x04;
        bits[line][col+1] = cur & 0x08;
        bits[line+1][col+1] = cur & 0x10;
        bits[line+2][col+1] = cur & 0x20;
        bits[line+3][col] = cur & 0x40;
        bits[line+3][col+1] = cur & 0x80;
        if (++count % 40 == 0 && (cur = utf8_getc_raw(fin)) != '\n') {
            /* Eat line feed */
            break;
        }
        if (count == 3*40) break;
        cur = utf8_getc_raw(fin);
        if (cur < 0x2800 || cur > 0x28FF) break;
    } while (count != 3*40);

    if (count != 3*40) {
	ungetbuf[ungetptr++] = cur;
        return;
    }
    for (line = 11; line >= 0; --line) {
        ungetbuf[ungetptr++] = '\n';
        for (col = 79; col >= 0; --col) {
            ungetbuf[ungetptr++] = bits[line][col] ? 'O' : '.';
        }
    }
}

/*
 * Read Unicode symbol from file.
 * Convert from UTF-8 encoding.
 */
static int
utf8_getc (FILE *fin)
{
    int c;
    /* Skip zero width no-break space. */
    while ((c = utf8_getc_raw (fin)) == 0xFEFF);
    if (0x2800 <= c && c <= 0x28FF) {
        /* Read a card image encoded as Braille pattern and convert to dots and Os */
        read_braille(c, fin);
        return utf8_getc(fin);
    }
    return c;
}

/*
 * Write Unicode symbol to file.
 * Convert to UTF-8 encoding:
 * 00000000.0xxxxxxx -> 0xxxxxxx
 * 00000xxx.xxyyyyyy -> 110xxxxx, 10yyyyyy
 * xxxxyyyy.yyzzzzzz -> 1110xxxx, 10yyyyyy, 10zzzzzz
 */
static void
utf8_putc (unsigned short ch, FILE *fout)
{
	static int initialized = 0;

	if (! initialized) {
		/* Write UTF-8 tag: zero width no-break space. */
		putc (0xEF, fout);
		putc (0xBB, fout);
		putc (0xBF, fout);
		initialized = 1;
	}
	if (ch < 0x80) {
		putc (ch, fout);
		return;
	}
	if (ch < 0x800) {
		putc (ch >> 6 | 0xc0, fout);
		putc ((ch & 0x3f) | 0x80, fout);
		return;
	}
	putc (ch >> 12 | 0xe0, fout);
	putc (((ch >> 6) & 0x3f) | 0x80, fout);
	putc ((ch & 0x3f) | 0x80, fout);
}

const unsigned short koi7_to_unicode [128] = {
	0x00,   0x01,   0x02,   0x03,   0x04,   0x05,   0x06,   0x07,
	0x08,   0x09,   0x0a,   0x0b,   0x0c,   0x0d,   0x0e,   0x0f,
	0x10,   0x11,   0x12,   0x13,   0x14,   0x15,   0x16,   0x17,
	0x18,   0x19,   0x1a,   0x1b,   0x1c,   0x1d,   0x1e,   0x1f,

	0x20,   0x21,   0x22,   0x23,   0x24,   0x25,   0x26,   0x27,
	0x28,   0x29,   0x2a,   0x2b,   0x2c,   0x2d,   0x2e,   0x2f,
	0x30,   0x31,   0x32,   0x33,   0x34,   0x35,   0x36,   0x37,
	0x38,   0x39,   0x3a,   0x3b,   0x3c,   0x3d,   0x3e,   0x3f,

	0x40,   0x41,   0x42,   0x43,   0x44,   0x45,   0x46,   0x47,
	0x48,   0x49,   0x4a,   0x4b,   0x4c,   0x4d,   0x4e,   0x4f,
	0x50,   0x51,   0x52,   0x53,   0x54,   0x55,   0x56,   0x57,
	0x58,   0x59,   0x5a,   0x5b,   0x5c,   0x5d,   0x5e,   0x5f,

	0x042e, 0x0410, 0x0411, 0x0426, 0x0414, 0x0415, 0x0424, 0x0413,
	0x0425, 0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e,
	0x041f, 0x042f, 0x0420, 0x0421, 0x0422, 0x0423, 0x0416, 0x0412,
	0x042c, 0x042b, 0x0417, 0x0428, 0x042d, 0x0429, 0x0427, 0x7f,
};

static const unsigned short koi8_to_unicode [256] = {
	0x00,   0x01,   0x02,   0x03,   0x04,   0x05,   0x06,   0x07,
	0x08,   0x09,   0x0a,   0x0b,   0x0c,   0x0d,   0x0e,   0x0f,
	0x10,   0x11,   0x12,   0x13,   0x14,   0x15,   0x16,   0x17,
	0x18,   0x19,   0x1a,   0x1b,   0x1c,   0x1d,   0x1e,   0x1f,
	0x20,   0x21,   0x22,   0x23,   0x24,   0x25,   0x26,   0x27,
	0x28,   0x29,   0x2a,   0x2b,   0x2c,   0x2d,   0x2e,   0x2f,
	0x30,   0x31,   0x32,   0x33,   0x34,   0x35,   0x36,   0x37,
	0x38,   0x39,   0x3a,   0x3b,   0x3c,   0x3d,   0x3e,   0x3f,
	0x40,   0x41,   0x42,   0x43,   0x44,   0x45,   0x46,   0x47,
	0x48,   0x49,   0x4a,   0x4b,   0x4c,   0x4d,   0x4e,   0x4f,
	0x50,   0x51,   0x52,   0x53,   0x54,   0x55,   0x56,   0x57,
	0x58,   0x59,   0x5a,   0x5b,   0x5c,   0x5d,   0x5e,   0x5f,
	0x60,   0x61,   0x62,   0x63,   0x64,   0x65,   0x66,   0x67,
	0x68,   0x69,   0x6a,   0x6b,   0x6c,   0x6d,   0x6e,   0x6f,
	0x70,   0x71,   0x72,   0x73,   0x74,   0x75,   0x76,   0x77,
	0x78,   0x79,   0x7a,   0x7b,   0x7c,   0x7d,   0x7e,   0x7f,
	0x2500, 0x2502, 0x250c, 0x2510, 0x2514, 0x2518, 0x251c, 0x2524,
	0x252c, 0x2534, 0x253c, 0x2580, 0x2584, 0x2588, 0x258c, 0x2590,
	0x2591, 0x2592, 0x2593, 0x2320, 0x25a0, 0x2219, 0x221a, 0x2248,
	0x2264, 0x2265, 0xa0,   0x2321, 0xb0,   0xb2,   0xb7,   0xf7,
	0x2550, 0x2551, 0x2552, 0x0451, 0x2553, 0x2554, 0x2555, 0x2556,
	0x2557, 0x2558, 0x2559, 0x255a, 0x255b, 0x255c, 0x255d, 0x255e,
	0x255f, 0x2560, 0x2561, 0x0401, 0x2562, 0x2563, 0x2564, 0x2565,
	0x2566, 0x2567, 0x2568, 0x2569, 0x256a, 0x256b, 0x256c, 0xa9,
	0x044e, 0x0430, 0x0431, 0x0446, 0x0434, 0x0435, 0x0444, 0x0433,
	0x0445, 0x0438, 0x0439, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e,
	0x043f, 0x044f, 0x0440, 0x0441, 0x0442, 0x0443, 0x0436, 0x0432,
	0x044c, 0x044b, 0x0437, 0x0448, 0x044d, 0x0449, 0x0447, 0x044a,
	0x042e, 0x0410, 0x0411, 0x0426, 0x0414, 0x0415, 0x0424, 0x0413,
	0x0425, 0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e,
	0x041f, 0x042f, 0x0420, 0x0421, 0x0422, 0x0423, 0x0416, 0x0412,
	0x042c, 0x042b, 0x0417, 0x0428, 0x042d, 0x0429, 0x0427, 0x042a,
};

/*
 * Read Unicode symbol from file.
 * Convert from KOI8-R encoding.
 */
static int
koi8_getc (FILE *fin)
{
	int c;

	c = getc (fin);
	if (c < 0)
		return c;
	return koi8_to_unicode [c];
}

static unsigned char
unicode_to_koi8 (unsigned short val)
{
	static unsigned char tab0 [256] = {
/* 00 - 07 */ 	0,     0x01,  0x02,  0x03,  0x04,  0x05,  0x06,  0x07,
/* 08 - 0f */ 	0x08,  0x09,  0x0a,  0x0b,  0x0c,  0x0d,  0x0e,  0x0f,
/* 10 - 17 */ 	0x10,  0x11,  0x12,  0x13,  0x14,  0x15,  0x16,  0x17,
/* 18 - 1f */ 	0x18,  0x19,  0x1a,  0x1b,  0x1c,  0x1d,  0x1e,  0x1f,
/*  !"#$%&' */	0x20,  0x21,  0x22,  0x23,  0x24,  0x25,  0x26,  0x27,
/* ()*+,-./ */	0x28,  0x29,  0x2a,  0x2b,  0x2c,  0x2d,  0x2e,  0x2f,
/* 01234567 */	0x30,  0x31,  0x32,  0x33,  0x34,  0x35,  0x36,  0x37,
/* 89:;<=>? */	0x38,  0x39,  0x3a,  0x3b,  0x3c,  0x3d,  0x3e,  0x3f,
/* @ABCDEFG */	0x40,  0x41,  0x42,  0x43,  0x44,  0x45,  0x46,  0x47,
/* HIJKLMNO */	0x48,  0x49,  0x4a,  0x4b,  0x4c,  0x4d,  0x4e,  0x4f,
/* PQRSTUVW */	0x50,  0x51,  0x52,  0x53,  0x54,  0x55,  0x56,  0x57,
/* XYZ[\]^_ */	0x58,  0x59,  0x5a,  0x5b,  0x5c,  0x5d,  0x5e,  0x5f,
/* `abcdefg */	0x60,  0x61,  0x62,  0x63,  0x64,  0x65,  0x66,  0x67,
/* hijklmno */	0x68,  0x69,  0x6a,  0x6b,  0x6c,  0x6d,  0x6e,  0x6f,
/* pqrstuvw */	0x70,  0x71,  0x72,  0x73,  0x74,  0x75,  0x76,  0x77,
/* xyz{|}~  */	0x78,  0x79,  0x7a,  0x7b,  0x7c,  0x7d,  0x7e,  0x7f,
/* 80 - 87 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 88 - 8f */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 90 - 97 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 98 - 9f */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* a0 - a7 */ 	0x9a,  0,     0,     0,     0,     0,     0,     0,
/* a8 - af */ 	0,     0xbf,  0,     0,     0x83,  0,     0,     0,
/* b0 - b7 */ 	0x9c,  0,     0x9d,  0,     0,     0,     0,     0x9e,
/* b8 - bf */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* c0 - c7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* c8 - cf */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* d0 - d7 */ 	0,     0,     0,     0,     0,     0,     0,     'x',
/* d8 - df */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* e0 - e7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* e8 - ef */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* f0 - f7 */ 	0,     0,     0,     0,     0,     0,     0,     0x9f,
/* f8 - ff */ 	0,     0,     0,     0,     0,     0,     0,     0,
	};
	switch (val >> 8) {
	case 0x00:
		return tab0 [val];
	case 0x04:
		switch ((unsigned char) val) {
		case 0x01: return 0xb3;
		case 0x10: return 0xe1;
		case 0x11: return 0xe2;
		case 0x12: return 0xf7;
		case 0x13: return 0xe7;
		case 0x14: return 0xe4;
		case 0x15: return 0xe5;
		case 0x16: return 0xf6;
		case 0x17: return 0xfa;
		case 0x18: return 0xe9;
		case 0x19: return 0xea;
		case 0x1a: return 0xeb;
		case 0x1b: return 0xec;
		case 0x1c: return 0xed;
		case 0x1d: return 0xee;
		case 0x1e: return 0xef;
		case 0x1f: return 0xf0;
		case 0x20: return 0xf2;
		case 0x21: return 0xf3;
		case 0x22: return 0xf4;
		case 0x23: return 0xf5;
		case 0x24: return 0xe6;
		case 0x25: return 0xe8;
		case 0x26: return 0xe3;
		case 0x27: return 0xfe;
		case 0x28: return 0xfb;
		case 0x29: return 0xfd;
		case 0x2a: return 0xff;
		case 0x2b: return 0xf9;
		case 0x2c: return 0xf8;
		case 0x2d: return 0xfc;
		case 0x2e: return 0xe0;
		case 0x2f: return 0xf1;
		case 0x30: return 0xc1;
		case 0x31: return 0xc2;
		case 0x32: return 0xd7;
		case 0x33: return 0xc7;
		case 0x34: return 0xc4;
		case 0x35: return 0xc5;
		case 0x36: return 0xd6;
		case 0x37: return 0xda;
		case 0x38: return 0xc9;
		case 0x39: return 0xca;
		case 0x3a: return 0xcb;
		case 0x3b: return 0xcc;
		case 0x3c: return 0xcd;
		case 0x3d: return 0xce;
		case 0x3e: return 0xcf;
		case 0x3f: return 0xd0;
		case 0x40: return 0xd2;
		case 0x41: return 0xd3;
		case 0x42: return 0xd4;
		case 0x43: return 0xd5;
		case 0x44: return 0xc6;
		case 0x45: return 0xc8;
		case 0x46: return 0xc3;
		case 0x47: return 0xde;
		case 0x48: return 0xdb;
		case 0x49: return 0xdd;
		case 0x4a: return 0xdf;
		case 0x4b: return 0xd9;
		case 0x4c: return 0xd8;
		case 0x4d: return 0xdc;
		case 0x4e: return 0xc0;
		case 0x4f: return 0xd1;
		case 0x51: return 0xa3;
		}
		break;
	case 0x20:
		switch ((unsigned char) val) {
		case 0x15: return '-';
		case 0x18: return '`';
		case 0x19: return '\'';
		case 0x28: return 0x0a;
		case 0x32: return '\'';
		}
		break;
	case 0x21:
		switch ((unsigned char) val) {
		case 0x2f: return 'e';
		case 0x91: return '@';
		}
		break;
	case 0x22:
		switch ((unsigned char) val) {
		case 0x19: return 0x95;
		case 0x1a: return 0x96;
		case 0x27: return '^';
		case 0x28: return 'v';
		case 0x48: return 0x97;
		case 0x60: return '#';
		case 0x64: return 0x98;
		case 0x65: return 0x99;
		}
		break;
	case 0x23:
		switch ((unsigned char) val) {
		case 0x20: return 0x93;
		case 0x21: return 0x9b;
		}
		break;
	case 0x25:
		switch ((unsigned char) val) {
		case 0x00: return 0x80;
		case 0x02: return 0x81;
		case 0x0c: return 0x82;
		case 0x10: return 0x83;
		case 0x14: return 0x84;
		case 0x18: return 0x85;
		case 0x1c: return 0x86;
		case 0x24: return 0x87;
		case 0x2c: return 0x88;
		case 0x34: return 0x89;
		case 0x3c: return 0x8a;
		case 0x50: return 0xa0;
		case 0x51: return 0xa1;
		case 0x52: return 0xa2;
		case 0x53: return 0xa4;
		case 0x54: return 0xa5;
		case 0x55: return 0xa6;
		case 0x56: return 0xa7;
		case 0x57: return 0xa8;
		case 0x58: return 0xa9;
		case 0x59: return 0xaa;
		case 0x5a: return 0xab;
		case 0x5b: return 0xac;
		case 0x5c: return 0xad;
		case 0x5d: return 0xae;
		case 0x5e: return 0xaf;
		case 0x5f: return 0xb0;
		case 0x60: return 0xb1;
		case 0x61: return 0xb2;
		case 0x62: return 0xb4;
		case 0x63: return 0xb5;
		case 0x64: return 0xb6;
		case 0x65: return 0xb7;
		case 0x66: return 0xb8;
		case 0x67: return 0xb9;
		case 0x68: return 0xba;
		case 0x69: return 0xbb;
		case 0x6a: return 0xbc;
		case 0x6b: return 0xbd;
		case 0x6c: return 0xbe;
		case 0x80: return 0x8b;
		case 0x84: return 0x8c;
		case 0x88: return 0x8d;
		case 0x8c: return 0x8e;
		case 0x90: return 0x8f;
		case 0x91: return 0x90;
		case 0x92: return 0x91;
		case 0x93: return 0x92;
		case 0xa0: return 0x94;
		case 0xca: return '$';
		}
		break;
	}
	return 0;
}

/*
 * Write Unicode symbol to file.
 * Convert to KOI8-R encoding.
 */
static void
koi8_putc (unsigned short ch, FILE *fout)
{
	ch = unicode_to_koi8 (ch);
	if (! ch)
		ch = '?';
	putc (ch, fout);
}

/*
 * Read Unicode symbol from file.
 * Convert from Windows code page 1251 encoding.
 */
static int
cp1251_getc (FILE *fin)
{
	static const unsigned short cp1251_to_unicode [256] = {
		0x00,   0x01,   0x02,   0x03,   0x04,   0x05,   0x06,   0x07,
		0x08,   0x09,   0x0a,   0x0b,   0x0c,   0x0d,   0x0e,   0x0f,
		0x10,   0x11,   0x12,   0x13,   0x14,   0x15,   0x16,   0x17,
		0x18,   0x19,   0x1a,   0x1b,   0x1c,   0x1d,   0x1e,   0x1f,
		0x20,   0x21,   0x22,   0x23,   0x24,   0x25,   0x26,   0x27,
		0x28,   0x29,   0x2a,   0x2b,   0x2c,   0x2d,   0x2e,   0x2f,
		0x30,   0x31,   0x32,   0x33,   0x34,   0x35,   0x36,   0x37,
		0x38,   0x39,   0x3a,   0x3b,   0x3c,   0x3d,   0x3e,   0x3f,
		0x40,   0x41,   0x42,   0x43,   0x44,   0x45,   0x46,   0x47,
		0x48,   0x49,   0x4a,   0x4b,   0x4c,   0x4d,   0x4e,   0x4f,
		0x50,   0x51,   0x52,   0x53,   0x54,   0x55,   0x56,   0x57,
		0x58,   0x59,   0x5a,   0x5b,   0x5c,   0x5d,   0x5e,   0x5f,
		0x60,   0x61,   0x62,   0x63,   0x64,   0x65,   0x66,   0x67,
		0x68,   0x69,   0x6a,   0x6b,   0x6c,   0x6d,   0x6e,   0x6f,
		0x70,   0x71,   0x72,   0x73,   0x74,   0x75,   0x76,   0x77,
		0x78,   0x79,   0x7a,   0x7b,   0x7c,   0x7d,   0x7e,   0x7f,
		0x0402, 0x0403, 0x201a, 0x0453, 0x201e, 0x2026, 0x2020, 0x2021,
		0x20ac, 0x2030, 0x0409, 0x2039, 0x040a, 0x040c, 0x040b, 0x040f,
		0x0452, 0x2018, 0x2019, 0x201c, 0x201d, 0x2022, 0x2013, 0x2014,
		0x98,   0x2122, 0x0459, 0x203a, 0x045a, 0x045c, 0x045b, 0x045f,
		0xa0,   0x040e, 0x045e, 0x0408, 0xa4,   0x0490, 0xa6,   0xa7,
		0x0401, 0xa9,   0x0404, 0xab,   0xac,   0xad,   0xae,   0x0407,
		0xb0,   0xb1,   0x0406, 0x0456, 0x0491, 0xb5,   0xb6,   0xb7,
		0x0451, 0x2116, 0x0454, 0xbb,   0x0458, 0x0405, 0x0455, 0x0457,
		0x0410, 0x0411, 0x0412, 0x0413, 0x0414, 0x0415, 0x0416, 0x0417,
		0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e, 0x041f,
		0x0420, 0x0421, 0x0422, 0x0423, 0x0424, 0x0425, 0x0426, 0x0427,
		0x0428, 0x0429, 0x042a, 0x042b, 0x042c, 0x042d, 0x042e, 0x042f,
		0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437,
		0x0438, 0x0439, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f,
		0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447,
		0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f,
	};
	int c;

	c = getc (fin);
	if (c < 0)
		return c;
	return cp1251_to_unicode [c];
}

static unsigned char
unicode_to_cp1251 (unsigned short val)
{
	static char tab0 [256] = {
/* 00 - 07 */ 	0,     0x01,  0x02,  0x03,  0x04,  0x05,  0x06,  0x07,
/* 08 - 0f */ 	0x08,  0x09,  0x0a,  0x0b,  0x0c,  0x0d,  0x0e,  0x0f,
/* 10 - 17 */ 	0x10,  0x11,  0x12,  0x13,  0x14,  0x15,  0x16,  0x17,
/* 18 - 1f */ 	0x18,  0x19,  0x1a,  0x1b,  0x1c,  0x1d,  0x1e,  0x1f,
/*  !"#$%&' */	0x20,  0x21,  0x22,  0x23,  0x24,  0x25,  0x26,  0x27,
/* ()*+,-./ */	0x28,  0x29,  0x2a,  0x2b,  0x2c,  0x2d,  0x2e,  0x2f,
/* 01234567 */	0x30,  0x31,  0x32,  0x33,  0x34,  0x35,  0x36,  0x37,
/* 89:;<=>? */	0x38,  0x39,  0x3a,  0x3b,  0x3c,  0x3d,  0x3e,  0x3f,
/* @ABCDEFG */	0x40,  0x41,  0x42,  0x43,  0x44,  0x45,  0x46,  0x47,
/* HIJKLMNO */	0x48,  0x49,  0x4a,  0x4b,  0x4c,  0x4d,  0x4e,  0x4f,
/* PQRSTUVW */	0x50,  0x51,  0x52,  0x53,  0x54,  0x55,  0x56,  0x57,
/* XYZ[\]^_ */	0x58,  0x59,  0x5a,  0x5b,  0x5c,  0x5d,  0x5e,  0x5f,
/* `abcdefg */	0x60,  0x61,  0x62,  0x63,  0x64,  0x65,  0x66,  0x67,
/* hijklmno */	0x68,  0x69,  0x6a,  0x6b,  0x6c,  0x6d,  0x6e,  0x6f,
/* pqrstuvw */	0x70,  0x71,  0x72,  0x73,  0x74,  0x75,  0x76,  0x77,
/* xyz{|}~  */	0x78,  0x79,  0x7a,  0x7b,  0x7c,  0x7d,  0x7e,  0x7f,
/* 80 - 87 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 88 - 8f */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 90 - 97 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 98 - 9f */ 	0x98,  0,     0,     0,     0,     0,     0,     0,
/* a0 - a7 */ 	0xa0,  0,     0,     0,     0xa4,  0,     0xa6,  0xa7,
/* a8 - af */ 	0,     0xa9,  0,     0xab,  0xac,  0xad,  0xae,  0,
/* b0 - b7 */ 	0xb0,  0xb1,  0,     0,     0,     0xb5,  0xb6,  0xb7,
/* b8 - bf */ 	0,     0,     0,     0xbb,  0,     0,     0,     0,
/* c0 - c7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* c8 - cf */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* d0 - d7 */ 	0,     0,     0,     0,     0,     0,     0,     'x',
/* d8 - df */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* e0 - e7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* e8 - ef */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* f0 - f7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* f8 - ff */ 	0,     0,     0,     0,     0,     0,     0,     0,
	};
	switch (val >> 8) {
	case 0x00:
		return tab0 [val];
	case 0x04:
		switch ((unsigned char) val) {
		case 0x01: return 0xa8;
		case 0x02: return 0x80;
		case 0x03: return 0x81;
		case 0x04: return 0xaa;
		case 0x05: return 0xbd;
		case 0x06: return 0xb2;
		case 0x07: return 0xaf;
		case 0x08: return 0xa3;
		case 0x09: return 0x8a;
		case 0x0a: return 0x8c;
		case 0x0b: return 0x8e;
		case 0x0c: return 0x8d;
		case 0x0e: return 0xa1;
		case 0x0f: return 0x8f;
		case 0x10: return 0xc0;
		case 0x11: return 0xc1;
		case 0x12: return 0xc2;
		case 0x13: return 0xc3;
		case 0x14: return 0xc4;
		case 0x15: return 0xc5;
		case 0x16: return 0xc6;
		case 0x17: return 0xc7;
		case 0x18: return 0xc8;
		case 0x19: return 0xc9;
		case 0x1a: return 0xca;
		case 0x1b: return 0xcb;
		case 0x1c: return 0xcc;
		case 0x1d: return 0xcd;
		case 0x1e: return 0xce;
		case 0x1f: return 0xcf;
		case 0x20: return 0xd0;
		case 0x21: return 0xd1;
		case 0x22: return 0xd2;
		case 0x23: return 0xd3;
		case 0x24: return 0xd4;
		case 0x25: return 0xd5;
		case 0x26: return 0xd6;
		case 0x27: return 0xd7;
		case 0x28: return 0xd8;
		case 0x29: return 0xd9;
		case 0x2a: return 0xda;
		case 0x2b: return 0xdb;
		case 0x2c: return 0xdc;
		case 0x2d: return 0xdd;
		case 0x2e: return 0xde;
		case 0x2f: return 0xdf;
		case 0x30: return 0xe0;
		case 0x31: return 0xe1;
		case 0x32: return 0xe2;
		case 0x33: return 0xe3;
		case 0x34: return 0xe4;
		case 0x35: return 0xe5;
		case 0x36: return 0xe6;
		case 0x37: return 0xe7;
		case 0x38: return 0xe8;
		case 0x39: return 0xe9;
		case 0x3a: return 0xea;
		case 0x3b: return 0xeb;
		case 0x3c: return 0xec;
		case 0x3d: return 0xed;
		case 0x3e: return 0xee;
		case 0x3f: return 0xef;
		case 0x40: return 0xf0;
		case 0x41: return 0xf1;
		case 0x42: return 0xf2;
		case 0x43: return 0xf3;
		case 0x44: return 0xf4;
		case 0x45: return 0xf5;
		case 0x46: return 0xf6;
		case 0x47: return 0xf7;
		case 0x48: return 0xf8;
		case 0x49: return 0xf9;
		case 0x4a: return 0xfa;
		case 0x4b: return 0xfb;
		case 0x4c: return 0xfc;
		case 0x4d: return 0xfd;
		case 0x4e: return 0xfe;
		case 0x4f: return 0xff;
		case 0x51: return 0xb8;
		case 0x52: return 0x90;
		case 0x53: return 0x83;
		case 0x54: return 0xba;
		case 0x55: return 0xbe;
		case 0x56: return 0xb3;
		case 0x57: return 0xbf;
		case 0x58: return 0xbc;
		case 0x59: return 0x9a;
		case 0x5a: return 0x9c;
		case 0x5b: return 0x9e;
		case 0x5c: return 0x9d;
		case 0x5e: return 0xa2;
		case 0x5f: return 0x9f;
		case 0x90: return 0xa5;
		case 0x91: return 0xb4;
		}
		break;
	case 0x20:
		switch ((unsigned char) val) {
		case 0x13: return 0x96;
		case 0x14: return 0x97;
		case 0x15: return '-';
		case 0x18: return 0x91;
		case 0x19: return 0x92;
		case 0x1a: return 0x82;
		case 0x1c: return 0x93;
		case 0x1d: return 0x94;
		case 0x1e: return 0x84;
		case 0x20: return 0x86;
		case 0x21: return 0x87;
		case 0x22: return 0x95;
		case 0x26: return 0x85;
		case 0x28: return 0x0a;
		case 0x30: return 0x89;
		case 0x32: return '\'';
		case 0x39: return 0x8b;
		case 0x3a: return 0x9b;
		case 0xac: return 0x88;
		}
		break;
	case 0x21:
		switch ((unsigned char) val) {
		case 0x16: return 0xb9;
		case 0x22: return 0x99;
		case 0x2f: return 'e';
		case 0x91: return '@';
		}
		break;
	case 0x22:
		switch ((unsigned char) val) {
		case 0x27: return '^';
		case 0x28: return 'v';
		case 0x60: return '#';
		}
		break;
	case 0x25:
		switch ((unsigned char) val) {
		case 0xca: return '$';
		}
		break;
	}
	return 0;
}

/*
 * Write Unicode symbol to file.
 * Convert to Windows code page 1251.
 */
static void
cp1251_putc (unsigned short ch, FILE *fout)
{
	ch = unicode_to_cp1251 (ch);
	if (! ch)
		ch = '?';
	putc (ch, fout);
}

/*
 * Read Unicode symbol from file.
 * Convert from Windows code page 866 encoding.
 */
static int
cp866_getc (FILE *fin)
{
	static const unsigned short cp866_to_unicode [256] = {
		0x00,   0x01,   0x02,   0x03,   0x04,   0x05,   0x06,   0x07,
		0x08,   0x09,   0x0a,   0x0b,   0x0c,   0x0d,   0x0e,   0x0f,
		0x10,   0x11,   0x12,   0x13,   0x14,   0x15,   0x16,   0x17,
		0x18,   0x19,   0x1a,   0x1b,   0x1c,   0x1d,   0x1e,   0x1f,
		0x20,   0x21,   0x22,   0x23,   0x24,   0x25,   0x26,   0x27,
		0x28,   0x29,   0x2a,   0x2b,   0x2c,   0x2d,   0x2e,   0x2f,
		0x30,   0x31,   0x32,   0x33,   0x34,   0x35,   0x36,   0x37,
		0x38,   0x39,   0x3a,   0x3b,   0x3c,   0x3d,   0x3e,   0x3f,
		0x40,   0x41,   0x42,   0x43,   0x44,   0x45,   0x46,   0x47,
		0x48,   0x49,   0x4a,   0x4b,   0x4c,   0x4d,   0x4e,   0x4f,
		0x50,   0x51,   0x52,   0x53,   0x54,   0x55,   0x56,   0x57,
		0x58,   0x59,   0x5a,   0x5b,   0x5c,   0x5d,   0x5e,   0x5f,
		0x60,   0x61,   0x62,   0x63,   0x64,   0x65,   0x66,   0x67,
		0x68,   0x69,   0x6a,   0x6b,   0x6c,   0x6d,   0x6e,   0x6f,
		0x70,   0x71,   0x72,   0x73,   0x74,   0x75,   0x76,   0x77,
		0x78,   0x79,   0x7a,   0x7b,   0x7c,   0x7d,   0x7e,   0x7f,
		0x0410, 0x0411, 0x0412, 0x0413, 0x0414, 0x0415, 0x0416, 0x0417,
		0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e, 0x041f,
		0x0420, 0x0421, 0x0422, 0x0423, 0x0424, 0x0425, 0x0426, 0x0427,
		0x0428, 0x0429, 0x042a, 0x042b, 0x042c, 0x042d, 0x042e, 0x042f,
		0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437,
		0x0438, 0x0439, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f,
		0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x2561, 0x2562, 0x2556,
		0x2555, 0x2563, 0x2551, 0x2557, 0x255d, 0x255c, 0x255b, 0x2510,
		0x2514, 0x2534, 0x252c, 0x251c, 0x2500, 0x253c, 0x255e, 0x255f,
		0x255a, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256c, 0x2567,
		0x2568, 0x2564, 0x2565, 0x2559, 0x2558, 0x2552, 0x2553, 0x256b,
		0x256a, 0x2518, 0x250c, 0x2588, 0x2584, 0x258c, 0x2590, 0x2580,
		0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447,
		0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f,
		0x0401, 0x0451, 0x0404, 0x0454, 0x0407, 0x0457, 0x040e, 0x045e,
		0xb0,   0x2219, 0xb7,   0x221a, 0x2116, 0xa4,   0x25a0, 0xa0,
	};
	int c;

	c = getc (fin);
	if (c < 0)
		return c;
	return cp866_to_unicode [c];
}

static unsigned char
unicode_to_cp866 (unsigned short val)
{
	static char tab0 [256] = {
/* 00 - 07 */ 	0,     0x01,  0x02,  0x03,  0x04,  0x05,  0x06,  0x07,
/* 08 - 0f */ 	0x08,  0x09,  0x0a,  0x0b,  0x0c,  0x0d,  0x0e,  0x0f,
/* 10 - 17 */ 	0x10,  0x11,  0x12,  0x13,  0x14,  0x15,  0x16,  0x17,
/* 18 - 1f */ 	0x18,  0x19,  0x1a,  0x1b,  0x1c,  0x1d,  0x1e,  0x1f,
/*  !"#$%&' */	0x20,  0x21,  0x22,  0x23,  0x24,  0x25,  0x26,  0x27,
/* ()*+,-./ */	0x28,  0x29,  0x2a,  0x2b,  0x2c,  0x2d,  0x2e,  0x2f,
/* 01234567 */	0x30,  0x31,  0x32,  0x33,  0x34,  0x35,  0x36,  0x37,
/* 89:;<=>? */	0x38,  0x39,  0x3a,  0x3b,  0x3c,  0x3d,  0x3e,  0x3f,
/* @ABCDEFG */	0x40,  0x41,  0x42,  0x43,  0x44,  0x45,  0x46,  0x47,
/* HIJKLMNO */	0x48,  0x49,  0x4a,  0x4b,  0x4c,  0x4d,  0x4e,  0x4f,
/* PQRSTUVW */	0x50,  0x51,  0x52,  0x53,  0x54,  0x55,  0x56,  0x57,
/* XYZ[\]^_ */	0x58,  0x59,  0x5a,  0x5b,  0x5c,  0x5d,  0x5e,  0x5f,
/* `abcdefg */	0x60,  0x61,  0x62,  0x63,  0x64,  0x65,  0x66,  0x67,
/* hijklmno */	0x68,  0x69,  0x6a,  0x6b,  0x6c,  0x6d,  0x6e,  0x6f,
/* pqrstuvw */	0x70,  0x71,  0x72,  0x73,  0x74,  0x75,  0x76,  0x77,
/* xyz{|}~  */	0x78,  0x79,  0x7a,  0x7b,  0x7c,  0x7d,  0x7e,  0x7f,
/* 80 - 87 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 88 - 8f */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 90 - 97 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* 98 - 9f */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* a0 - a7 */ 	0xff,  0,     0,     0,     0xfd,  0,     0,     0,
/* a8 - af */ 	0,     0,     0,     0,     '^',   0,     0,     0,
/* b0 - b7 */ 	0xf8,  0,     0,     0,     0,     0,     0,     0xfa,
/* b8 - bf */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* c0 - c7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* c8 - cf */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* d0 - d7 */ 	0,     0,     0,     0,     0,     0,     0,     'x',
/* d8 - df */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* e0 - e7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* e8 - ef */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* f0 - f7 */ 	0,     0,     0,     0,     0,     0,     0,     0,
/* f8 - ff */ 	0,     0,     0,     0,     0,     0,     0,     0,
	};
	switch (val >> 8) {
	case 0x00:
		return tab0 [val];
	case 0x04:
		switch ((unsigned char) val) {
		case 0x01: return 0xf0;
		case 0x04: return 0xf2;
		case 0x07: return 0xf4;
		case 0x0e: return 0xf6;
		case 0x10: return 0x80;
		case 0x11: return 0x81;
		case 0x12: return 0x82;
		case 0x13: return 0x83;
		case 0x14: return 0x84;
		case 0x15: return 0x85;
		case 0x16: return 0x86;
		case 0x17: return 0x87;
		case 0x18: return 0x88;
		case 0x19: return 0x89;
		case 0x1a: return 0x8a;
		case 0x1b: return 0x8b;
		case 0x1c: return 0x8c;
		case 0x1d: return 0x8d;
		case 0x1e: return 0x8e;
		case 0x1f: return 0x8f;
		case 0x20: return 0x90;
		case 0x21: return 0x91;
		case 0x22: return 0x92;
		case 0x23: return 0x93;
		case 0x24: return 0x94;
		case 0x25: return 0x95;
		case 0x26: return 0x96;
		case 0x27: return 0x97;
		case 0x28: return 0x98;
		case 0x29: return 0x99;
		case 0x2a: return 0x9a;
		case 0x2b: return 0x9b;
		case 0x2c: return 0x9c;
		case 0x2d: return 0x9d;
		case 0x2e: return 0x9e;
		case 0x2f: return 0x9f;
		case 0x30: return 0xa0;
		case 0x31: return 0xa1;
		case 0x32: return 0xa2;
		case 0x33: return 0xa3;
		case 0x34: return 0xa4;
		case 0x35: return 0xa5;
		case 0x36: return 0xa6;
		case 0x37: return 0xa7;
		case 0x38: return 0xa8;
		case 0x39: return 0xa9;
		case 0x3a: return 0xaa;
		case 0x3b: return 0xab;
		case 0x3c: return 0xac;
		case 0x3d: return 0xad;
		case 0x3e: return 0xae;
		case 0x3f: return 0xaf;
		case 0x40: return 0xe0;
		case 0x41: return 0xe1;
		case 0x42: return 0xe2;
		case 0x43: return 0xe3;
		case 0x44: return 0xe4;
		case 0x45: return 0xe5;
		case 0x46: return 0xe6;
		case 0x47: return 0xe7;
		case 0x48: return 0xe8;
		case 0x49: return 0xe9;
		case 0x4a: return 0xea;
		case 0x4b: return 0xeb;
		case 0x4c: return 0xec;
		case 0x4d: return 0xed;
		case 0x4e: return 0xee;
		case 0x4f: return 0xef;
		case 0x51: return 0xf1;
		case 0x54: return 0xf3;
		case 0x57: return 0xf5;
		case 0x5e: return 0xf7;
		}
		break;
	case 0x20:
		switch ((unsigned char) val) {
		case 0x15: return '-';
		case 0x18: return '`';
		case 0x19: return '\'';
		case 0x28: return 0x0a;
		case 0x32: return '\'';
		}
		break;
	case 0x21:
		switch ((unsigned char) val) {
		case 0x16: return 0xfc;
		case 0x2f: return 'e';
		case 0x91: return '@';
		}
		break;
	case 0x22:
		switch ((unsigned char) val) {
		case 0x19: return 0xf9;
		case 0x1a: return 0xfb;
		case 0x27: return '^';
		case 0x28: return 'v';
		case 0x60: return '#';
		}
		break;
	case 0x25:
		switch ((unsigned char) val) {
		case 0x00: return 0xc4;
		case 0x02: return 0xb3;
		case 0x0c: return 0xda;
		case 0x10: return 0xbf;
		case 0x14: return 0xc0;
		case 0x18: return 0xd9;
		case 0x1c: return 0xc3;
		case 0x24: return 0xb4;
		case 0x2c: return 0xc2;
		case 0x34: return 0xc1;
		case 0x3c: return 0xc5;
		case 0x50: return 0xcd;
		case 0x51: return 0xba;
		case 0x52: return 0xd5;
		case 0x53: return 0xd6;
		case 0x54: return 0xc9;
		case 0x55: return 0xb8;
		case 0x56: return 0xb7;
		case 0x57: return 0xbb;
		case 0x58: return 0xd4;
		case 0x59: return 0xd3;
		case 0x5a: return 0xc8;
		case 0x5b: return 0xbe;
		case 0x5c: return 0xbd;
		case 0x5d: return 0xbc;
		case 0x5e: return 0xc6;
		case 0x5f: return 0xc7;
		case 0x60: return 0xcc;
		case 0x61: return 0xb5;
		case 0x62: return 0xb6;
		case 0x63: return 0xb9;
		case 0x64: return 0xd1;
		case 0x65: return 0xd2;
		case 0x66: return 0xcb;
		case 0x67: return 0xcf;
		case 0x68: return 0xd0;
		case 0x69: return 0xca;
		case 0x6a: return 0xd8;
		case 0x6b: return 0xd7;
		case 0x6c: return 0xce;
		case 0x80: return 0xdf;
		case 0x84: return 0xdc;
		case 0x88: return 0xdb;
		case 0x8c: return 0xdd;
		case 0x90: return 0xde;
		case 0x91: return 0xb0;
		case 0x92: return 0xb1;
		case 0x93: return 0xb2;
		case 0xa0: return 0xfe;
		case 0xca: return '$';
		}
		break;
	}
	return 0;
}

/*
 * Write Unicode symbol to file.
 * Convert to Windows code page 866.
 */
static void
cp866_putc (unsigned short ch, FILE *fout)
{
	ch = unicode_to_cp866 (ch);
	if (! ch)
		ch = '?';
	putc (ch, fout);
}

static void
fatal_encoding (char *lang)
{
	fprintf (stderr, gettext ("Encoding %s is not supported.\n"
		"Use UTF-8, KOI8-R, CP1251 or CP866.\n"), lang);
	exit (1);
}

static void
init_local_encoding ()
{
	char *lang, *p;

	lang = getenv ("LANG");
	if (! lang)
#ifdef __CYGWIN__
		lang = "en_US.cp1251";
#else
		lang = "en_US.utf8";
#endif

	/* Strip optional modifier. */
	p = strchr (lang, '@');
	if (p)
		*p = 0;

	/* Get codeset. */
	p = strchr (lang, '.');
	if (p)
		lang = p+1;

	if (strncasecmp (lang, "koi8", 4) == 0) {
		/* KOI8-R, KOI8-U and others. */
		local_putc = koi8_putc;
		if (! local_getc)
			local_getc = koi8_getc;
		return;
	}
	if (strcasecmp (lang, "cp1251") == 0 ||
	    strcasecmp (lang, "cp-1251") == 0) {
		/* Windows code page 1251. */
		local_putc = cp1251_putc;
		if (! local_getc)
			local_getc = cp1251_getc;
		return;
	}
	if (strcasecmp (lang, "cp866") == 0 ||
	    strcasecmp (lang, "cp-866") == 0) {
		/* Windows code page 866. */
		local_putc = cp866_putc;
		if (! local_getc)
			local_getc = cp866_getc;
		return;
	}
	if (strcasecmp (lang, "utf8") == 0 ||
	    strcasecmp (lang, "utf-8") == 0) {
		/* UTF-8. */
		local_putc = utf8_putc;
		if (! local_getc)
			local_getc = utf8_getc;
		return;
	}
	fatal_encoding (lang);
}

void
set_input_encoding (char *lang)
{
	if (! lang)
		return;
	if (strncasecmp (lang, "koi8", 4) == 0) {
		/* KOI8-R, KOI8-U and others. */
		local_getc = koi8_getc;
		return;
	}
	if (strcasecmp (lang, "cp1251") == 0 ||
	    strcasecmp (lang, "cp-1251") == 0) {
		/* Windows code page 1251. */
		local_getc = cp1251_getc;
		return;
	}
	if (strcasecmp (lang, "cp866") == 0 ||
	    strcasecmp (lang, "cp-866") == 0) {
		/* Windows code page 866. */
		local_getc = cp866_getc;
		return;
	}
	if (strcasecmp (lang, "utf8") == 0 ||
	    strcasecmp (lang, "utf-8") == 0) {
		/* UTF-8. */
		local_getc = utf8_getc;
		return;
	}
	fatal_encoding (lang);
}

/*
 * Read Unicode symbol from file.
 * Convert from local encoding (UTF-8, KOI8-R, CP-1251, CP-866).
 */
int
unicode_getc (FILE *fin)
{
	if (! local_getc)
		init_local_encoding();
	return local_getc (fin);
}

/*
 * Write Unicode symbol to file.
 * Convert to local encoding (UTF-8, KOI8-R, CP-1251, CP-866).
 */
void
unicode_putc (unsigned short ch, FILE *fout)
{
	if (! local_putc)
		init_local_encoding();
	local_putc (ch, fout);
}

/*
 * Fetch GOST-10859 symbol from UTF-8 string.
 * Advance string pointer.
 */
unsigned char
utf8_to_gost (unsigned char **p)
{
	int c1, c2, c3;

	c1 = *(*p)++;
	if (! (c1 & 0x80))
		return unicode_to_gost (c1);
	c2 = *(*p)++;
	if (! (c1 & 0x20))
		return unicode_to_gost ((c1 & 0x1f) << 6 | (c2 & 0x3f));
	c3 = *(*p)++;
	return unicode_to_gost ((c1 & 0x0f) << 12 | (c2 & 0x3f) << 6 |
		(c3 & 0x3f));
}

unsigned short
gost_to_unicode (unsigned char ch)
{
	return gost_latin ? gost_to_unicode_lat [ch] :
		gost_to_unicode_cyr [ch];
}

/*
 * Write GOST-10859 symbol to file.
 * Convert to local encoding (UTF-8, KOI8-R, CP-1251, CP-866).
 */
void
gost_putc (unsigned char ch, FILE *fout)
{
	unsigned short u;

	u = gost_to_unicode (ch);
	if (! u)
		u = ' ';
	unicode_putc (u, fout);
}

/*
 * Write GOST-10859 string to file.
 * Convert to local encoding (UTF-8, KOI8-R, CP-1251, CP-866).
 */
void
gost_write (unsigned char *line, int n, FILE *fout)
{
	unsigned short u;

	while (n-- > 0) {
		u = gost_to_unicode (*line++);
		if (! u)
			u = ' ';
		unicode_putc (u, fout);
	}
}

/*
 * Put UTF-8 string to file.
 * Convert to local encoding (UTF-8, KOI8-R, CP-1251, CP-866).
 */
void
utf8_puts (const char *line, FILE *fout)
{
	int c1, c2, c3;

	while (*line) {
		c1 = *line++;
		if (! (c1 & 0x80)) {
			unicode_putc (c1, fout);
			continue;
		}
		c2 = *line++;
		if (! (c1 & 0x20)) {
			unicode_putc ((c1 & 0x1f) << 6 | (c2 & 0x3f), fout);
			continue;
		}
		c3 = *line++;
		unicode_putc ((c1 & 0x0f) << 12 | (c2 & 0x3f) << 6 |
			(c3 & 0x3f), fout);
	}
}
